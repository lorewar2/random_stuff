import h5py
import pandas as pd

pd.set_option("display.max_rows", None)


# # Path to your file
# file_path = "day11.h5"

# with h5py.File(file_path, "r") as f:
#     # Categorical donor ID mapping
#     categories = [x.decode() for x in f["obs/__categories/pool_id"][:]]
#     donor_indices = f["obs/pool_id"][:]  # integer codes
#     donors = [categories[i] for i in donor_indices]

# # Convert to dataframe for inspection
# donor_df = pd.DataFrame({"pool_id": donors})
# print(donor_df)
# print("Unique donors:", donor_df["pool_id"].unique())

import scanpy as sc

adata = sc.read_h5ad("day11.h5")

# Show donor column in cell metadata
#print(adata.obs["donor_id"].value_counts())

pool4 = adata.obs#[adata.obs["pool_id"] == "pool5"]

donor_barcodes = (
    pool4.groupby(["pool_id", "sample_id", "donor_id"])
    .apply(lambda x: list(x.index))  # x.index contains the cell barcodes
    .reset_index(name="cell_barcodes")
)
# Filter out entries with zero cells
donor_barcodes["n_cells"] = donor_barcodes["cell_barcodes"].apply(len)
donor_barcodes = donor_barcodes[donor_barcodes["n_cells"] > 0]
#donor_barcodes = donor_barcodes[donor_barcodes["sample_id"] == "5245STDY7632695"]

# Print results
print("Cell barcodes for each donor in Pool 4:")
print(donor_barcodes[["donor_id", "sample_id", "pool_id", "n_cells", "cell_barcodes"]])

#5245STDY7487301 - pool 4 SAMEA6833385
# 25923_1#1.cram	ERR4700079	ERS4561002	5245STDY7487301
# 25923_1#2.cram	ERR4700080	ERS4561002	5245STDY7487301
# 25923_1#3.cram	ERR4700081	ERS4561002	5245STDY7487301
# 25923_1#4.cram	ERR4700082	ERS4561002	5245STDY7487301
# 50    HPSI0115i-aion_2  5245STDY7487301   pool4      324  [AAACGGGAGAGTCGGT-1-6, AAACGGGCAATTCCTT-1-6, A...
# 51    HPSI0115i-bimq_4  5245STDY7487301   pool4      271  [AAACCTGCACTGAAGG-1-6, AAACGGGCATCATCCC-1-6, A...
# 52    HPSI0115i-boqx_2  5245STDY7487301   pool4       73  [AACTCCCAGTGGAGTC-1-6, AAGCCGCGTAAAGTCA-1-6, A...
# 53    HPSI0115i-gifk_1  5245STDY7487301   pool4       83  [AAACGGGCAAAGTCAA-1-6, AAATGCCAGCTCAACT-1-6, A...
# 54    HPSI0214i-feec_2  5245STDY7487301   pool4      375  [AAACGGGAGAAGGTTT-1-6, AAATGCCTCTGTTTGT-1-6, A...
# 55    HPSI0214i-giju_3  5245STDY7487301   pool4      492  [AAACCTGTCCGTTGCT-1-6, AAACCTGTCTTACCTA-1-6, A...
# 56    HPSI0215i-deyz_2  5245STDY7487301   pool4      711  [AAACCTGCACCATGTA-1-6, AAACCTGTCGATCCCT-1-6, A...
# 57    HPSI0215i-fawm_2  5245STDY7487301   pool4      698  [AAACCTGCACGGCCAT-1-6, AAACGGGAGGACCACA-1-6, A...
# 58    HPSI0314i-cuhk_2  5245STDY7487301   pool4      471  [AAACCTGGTTCCACAA-1-6, AAACGGGTCAAGCCTA-1-6, A...
# 59    HPSI0314i-sojd_3  5245STDY7487301   pool4      221  [AAAGATGAGGTACTCT-1-6, AAAGATGAGTGATCGG-1-6, A...
# 60    HPSI0414i-ceik_1  5245STDY7487301   pool4      192  [AAACCTGAGTGGGCTA-1-6, AAACGGGAGTGTTAGA-1-6, A...
# 61    HPSI0514i-fiaj_1  5245STDY7487301   pool4      896  [AAACGGGAGAATGTGT-1-6, AAACGGGGTATAGTAG-1-6, A...
# 62    HPSI0514i-lako_1  5245STDY7487301   pool4      335  [AAAGCAAGTTCACGGC-1-6, AAATGCCTCGTTGCCT-1-6, A...
# 63    HPSI0714i-burb_1  5245STDY7487301   pool4      402  [AAACCTGAGGGTATCG-1-6, AAACCTGCAAACGCGA-1-6, A...
# 64    HPSI0814i-bokz_6  5245STDY7487301   pool4      147  [AACCATGGTAAGGGAA-1-6, AACCGCGTCGCCTGAG-1-6, A...
# 65    HPSI1014i-bilx_1  5245STDY7487301   pool4       66  [AAAGATGAGCTAACAA-1-6, AACACGTAGGGTATCG-1-6, A...
# 66    HPSI1014i-eesb_1  5245STDY7487301   pool4     1514  [AAACCTGAGGTGTTAA-1-6, AAACCTGTCTACTTAC-1-6, A...
# 67    HPSI1213i-hehd_1  5245STDY7487301   pool4      605  [AAACGGGGTCCTCTTG-1-6, AAAGATGAGAGAACAG-1-6, A...
#5245STDY7602378 - pool 6 SAMEA6833405 24 donors
#26558_2#1.cram	ERR4700155	ERS4561022	5245STDY7602378
#26558_2#2.cram	ERR4700156	ERS4561022	5245STDY7602378
#26558_2#3.cram	ERR4700157	ERS4561022	5245STDY7602378
#26558_2#4.cram	ERR4700158	ERS4561022	5245STDY7602378
# 221   HPSI0114i-wegi_1  5245STDY7602378   pool6      484  [AAACCTGGTCAGGACA-1-14, AAACGGGGTACTTGAC-1-14,...
# 222   HPSI0115i-zihe_1  5245STDY7602378   pool6      153  [AACCATGTCAGCTCGG-1-14, AACTGGTCATTCACTT-1-14,...
# 223   HPSI0214i-heth_1  5245STDY7602378   pool6      171  [AAACCTGTCCCATTAT-1-14, AAAGATGTCATCTGTT-1-14,...
# 224   HPSI0215i-hipn_1  5245STDY7602378   pool6      335  [AAACCTGGTGTCAATC-1-14, AAACGGGGTAGATTAG-1-14,...
# 225   HPSI0215i-yoch_6  5245STDY7602378   pool6      160  [AAACGGGGTGCACTTA-1-14, AAAGATGCATGTCTCC-1-14,...
# 226   HPSI0314i-qaqx_1  5245STDY7602378   pool6      142  [AAAGCAACAAACTGCT-1-14, AAAGTAGTCTCCTATA-1-14,...
# 227   HPSI0314i-uict_1  5245STDY7602378   pool6      169  [AAACCTGTCGCCTGTT-1-14, AAAGATGAGGATGGAA-1-14,...
# 228   HPSI0314i-xagu_1  5245STDY7602378   pool6       89  [AAGGCAGGTCCCGACA-1-14, AATCCAGCAGTTAACC-1-14,...
# 229   HPSI0414i-mita_1  5245STDY7602378   pool6      500  [AAACCTGAGATCCCAT-1-14, AAACCTGGTGGTGTAG-1-14,...
# 230   HPSI0514i-qihv_1  5245STDY7602378   pool6      244  [AAACCTGAGCTACCTA-1-14, AAACGGGCATGCTAGT-1-14,...
# 231   HPSI0514i-suul_1  5245STDY7602378   pool6      228  [AAACGGGAGCAGACTG-1-14, AAACGGGTCTAGAGTC-1-14,...
# 232   HPSI0514i-tert_1  5245STDY7602378   pool6      287  [AAACGGGTCCAAGCCG-1-14, AAAGATGCAAGACGTG-1-14,...
# 233   HPSI0614i-voce_1  5245STDY7602378   pool6      283  [AAACGGGCACGCTTTC-1-14, AAACGGGCAGACAAAT-1-14,...
# 234   HPSI0714i-oatm_1  5245STDY7602378   pool6      152  [AAACGGGTCGTATCAG-1-14, AAAGATGTCTATCCCG-1-14,...
# 235   HPSI0914i-laey_6  5245STDY7602378   pool6      207  [AAAGCAACATACTCTT-1-14, AAATGCCCATACTACG-1-14,...
# 236   HPSI1013i-hiaf_1  5245STDY7602378   pool6      414  [AAACGGGCATCCTAGA-1-14, AAACGGGGTAGGACAC-1-14,...
# 237   HPSI1013i-woci_1  5245STDY7602378   pool6      321  [AAACCTGCAGACTCGC-1-14, AAACCTGTCAGTACGT-1-14,...
# 238   HPSI1013i-zagm_1  5245STDY7602378   pool6      100  [AAACGGGAGCTTATCG-1-14, AACACGTCAGCATGAG-1-14,...
# 239   HPSI1014i-nosn_1  5245STDY7602378   pool6      167  [AAATGCCAGCGGCTTC-1-14, AACCATGGTAGCTGCC-1-14,...
# 240   HPSI1014i-sehl_6  5245STDY7602378   pool6      305  [AAACCTGAGATCCTGT-1-14, AAACGGGAGTGTCCCG-1-14,...
# 241   HPSI1014i-tuju_1  5245STDY7602378   pool6      213  [AAAGCAAAGTGAAGAG-1-14, AAAGTAGAGAATTCCC-1-14,...
# 242   HPSI1114i-kuul_1  5245STDY7602378   pool6      206  [AAAGATGAGTACGATA-1-14, AAAGATGGTGCCTGGT-1-14,...
# 243   HPSI1114i-ualf_6  5245STDY7602378   pool6      128  [AAACCTGAGAGTACCG-1-14, AAACCTGTCGACGGAA-1-14,...
# 244   HPSI1213i-tolg_4  5245STDY7602378   pool6       78  [AAAGATGCACATAACC-1-14, AACACGTCACGTTGGC-1-14,...
#5245STDY7632696 - pool 8 SAMEA6833432 19 donors
#26873_3#1.cram	ERR4700275	ERS4561049	5245STDY7632696
#26873_3#2.cram	ERR4700276	ERS4561049	5245STDY7632696
#26873_3#3.cram	ERR4700277	ERS4561049	5245STDY7632696
#26873_3#4.cram	ERR4700278	ERS4561049	5245STDY7632696
# 467   HPSI0115i-aoxv_1  5245STDY7632696   pool8      855  [AAACCTGAGCTGTCTA-1-25, AAACCTGGTGCATCTA-1-25,...
# 468   HPSI0215i-romx_1  5245STDY7632696   pool8      621  [AAACCTGAGGTCGGAT-1-25, AAACCTGGTAAATGAC-1-25,...
# 469   HPSI0215i-zett_5  5245STDY7632696   pool8      667  [AAACCTGAGTAGGTGC-1-25, AAACCTGGTAGCACGA-1-25,...
# 470   HPSI0314i-xugn_2  5245STDY7632696   pool8      391  [AAACCTGAGCGACGTA-1-25, AAACGGGGTTGGGACA-1-25,...
# 471   HPSI0414i-oaqd_2  5245STDY7632696   pool8      339  [AAAGATGAGCCCAGCT-1-25, AAAGATGGTCTGCAAT-1-25,...
# 472   HPSI0414i-uawq_2  5245STDY7632696   pool8      376  [AAACGGGCAAGTTAAG-1-25, AAAGATGGTTAAGACA-1-25,...
# 473   HPSI0414i-xojn_3  5245STDY7632696   pool8      527  [AAACCTGAGAGTTGGC-1-25, AAACCTGAGTACGCCC-1-25,...
# 474   HPSI0514i-oekw_2  5245STDY7632696   pool8      272  [AAACCTGTCGGCGGTT-1-25, AAACGGGCATTGGGCC-1-25,...
# 475   HPSI0514i-wiii_3  5245STDY7632696   pool8      223  [AAAGATGCAATGGAGC-1-25, AACCATGTCGACAGCC-1-25,...
# 476   HPSI0614i-miaj_4  5245STDY7632696   pool8      770  [AAACCTGCATACTACG-1-25, AAACCTGGTACTCAAC-1-25,...
# 477   HPSI0614i-qunz_2  5245STDY7632696   pool8       93  [AACCATGCACGAAATA-1-25, AACCGCGAGCAAATCA-1-25,...
# 478   HPSI0715i-aowh_2  5245STDY7632696   pool8      515  [AAACCTGCATACCATG-1-25, AAACGGGTCTATCCTA-1-25,...
# 479   HPSI0715i-zaie_5  5245STDY7632696   pool8      409  [AAAGCAACATCGATGT-1-25, AAAGTAGTCACGACTA-1-25,...
# 480   HPSI0914i-ouvb_2  5245STDY7632696   pool8      343  [AAAGTAGAGTCTCCTC-1-25, AAATGCCCATACGCCG-1-25,...
# 481   HPSI0914i-zerv_7  5245STDY7632696   pool8      195  [AAACCTGAGGTAGCCA-1-25, AAAGATGCACCTCGGA-1-25,...
# 482   HPSI1013i-sita_1  5245STDY7632696   pool8      532  [AAAGATGGTTACGACT-1-25, AAAGCAAAGCAGACTG-1-25,...
# 483   HPSI1014i-babz_3  5245STDY7632696   pool8      442  [AAACCTGGTCTCCACT-1-25, AAACGGGAGTGGGTTG-1-25,...
# 484   HPSI1014i-kefb_1  5245STDY7632696   pool8      145  [AACCGCGAGCGATCCC-1-25, AACTCAGGTCACCTAA-1-25,...
# 485   HPSI1014i-vils_1  5245STDY7632696   pool8      500  [AAACCTGGTCTAACGT-1-25, AAACGGGGTCCGCTGA-1-25,...





# import scanpy as sc
# import pandas as pd

# # Load your single-cell h5ad / h5 file
# adata = sc.read_h5ad("day11.h5")

# # Ensure pool_id and donor_id columns exist
# if "pool_id" not in adata.obs or "donor_id" not in adata.obs:
#     raise ValueError("File is missing 'pool_id' or 'donor_id' fields in .obs")

# # Filter only Pool 4 cells
# pool4 = adata.obs[adata.obs["pool_id"] == "pool4"].copy()

# # Keep only barcodes with a donor_id
# pool4 = pool4[pool4["donor_id"].notna()]
# pool4 = pool4[pool4["sample_id"] == "5245STDY7487301"]

# # Create a flat DataFrame with barcode and donor_id
# barcode_df = pd.DataFrame({
#     "barcode": pool4.index,
#     "donor_id": pool4["donor_id"].values
# })

# # Sort by barcode
# barcode_df = barcode_df.sort_values("barcode").reset_index(drop=True)

# # Display all rows if needed
# pd.set_option("display.max_rows", None)

# # Print result
# print(barcode_df)

# barcode_df.to_csv("pool4_barcodes_donors.csv", index=False)